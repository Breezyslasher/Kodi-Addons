<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<addon id="plugin.audio.musicassistant" name="Music Assistant" version="2.4.4" provider-name="Breezyslasher">
    <requires>
        <import addon="xbmc.python" version="3.0.0"/>
        <import addon="script.module.requests" version="2.22.0"/>
    </requires>
    <extension point="xbmc.python.pluginsource" library="addon.py">
        <provides>audio</provides>
    </extension>
    <extension point="xbmc.addon.metadata">
        <platform>all</platform>
        <license>Apache-2.0</license>
        <forum></forum>
        <website>https://music-assistant.io</website>
        <source>https://github.com/music-assistant/client</source>
        <summary lang="en_GB">Music Assistant for Kodi</summary>
        <summary lang="en_US">Music Assistant for Kodi</summary>
        <description lang="en_GB">Browse and play music from your Music Assistant 2.7+ server. Connect to your Music Assistant instance to access your entire music library including artists, albums, tracks, playlists, radio stations, podcasts, and audiobooks.</description>
        <description lang="en_US">Browse and play music from your Music Assistant 2.7+ server. Connect to your Music Assistant instance to access your entire music library including artists, albums, tracks, playlists, radio stations, podcasts, and audiobooks.</description>
        <disclaimer lang="en_GB">This addon requires a running Music Assistant server (version 2.7 or newer).</disclaimer>
        <disclaimer lang="en_US">This addon requires a running Music Assistant server (version 2.7 or newer).</disclaimer>
        <assets>
            <icon>resources/media/icon.png</icon>
            <fanart>resources/media/fanart.jpg</fanart>
        </assets>
        <news>
v2.4.4 (2024-12-25)
- Steam Deck fix: Launch sendspin through login shell to initialize environment
- Uses: flatpak-spawn --host /bin/bash -lc "sendspin --headless"
- All Flatpak commands now use login shell for proper PATH setup
- Process detection (pgrep/ps) also uses flatpak-spawn in Flatpak environments

v2.4.3 (2024-12-25)
- Fixed path expansion bug (missing leading / in paths like home/deck/...)
- Added Hide/Show Players feature:
  - Long-press on player in Players list to hide it
  - Hidden players won't appear in player selection dialogs
  - Toggle "Show Hidden Players" to see and unhide them
- Hidden players setting stored in addon settings

v2.4.2 (2024-12-25)
- Fixed sendspin path detection for Steam Deck and other Flatpak environments
- Properly expands ~ to host home directory when using flatpak-spawn
- Auto-detects host username in Flatpak for better path detection
- Added Steam Deck specific paths (/home/deck/.local/bin/sendspin)

v2.4.1 (2024-12-25)
- Removed auto-install sendspin feature (simplification)
- Addon only launches sendspin if already installed
- Install sendspin manually with: pip install sendspin

v2.4.0 (2024-12-25)
- Added Play Options menu when clicking tracks:
  - Play Now (default)
  - Play Now (Clear Queue)
  - Play Next
  - Add to Queue
  - Play on Different Player
- Context menus for tracks, albums, and playlists now have all play options
- Can select a different player for one-time playback

v2.3.1 (2024-12-25)
- Fixed Player Controls - now uses folders to prevent "unplayable item" errors
- Controls execute action then refresh the controls menu

v2.3.0 (2024-12-25)
- Added Player Controls menu with:
  - Play/Pause, Next, Previous, Stop
  - Shuffle toggle (shows current status)
  - Clear Queue
  - Volume Up/Down
  - Sync with Another Player (group players)
  - Unsync Player
  - Transfer Queue to Another Player
- Shows current playing track in controls menu

v2.2.1 (2024-12-25)
- Prevent multiple sendspin instances - checks system-wide before starting
- Uses pgrep and ps to detect existing sendspin processes

v2.2.0 (2024-12-25)
- Added Flatpak support - uses flatpak-spawn --host to run sendspin from sandbox
- Works with both apt and Flatpak versions of Kodi

v2.1.9 (2024-12-25)
- Simplified sendspin command to just: /usr/local/bin/sendspin --headless
- Removed --name and --url parameters (sendspin auto-discovers)

v2.1.8 (2024-12-25)
- Fixed player name - replaces spaces with dashes (e.g. Kodi-hostname)
- Always sends --name parameter with safe default

v2.1.7 (2024-12-25)
- Fixed sendspin command - removed problematic parentheses from player name
- Simplified sendspin startup - only adds --name if explicitly set in settings
- Command now works without special characters causing syntax errors

v2.1.6 (2024-12-25)
- Fixed settings format - now uses simple category format that works properly
- Settings now show in categories: Server, Playback, Display

v2.1.5 (2024-12-25)
- Fixed Sendspin Path setting visibility - now always shows when auto-start is enabled

v2.1.4 (2024-12-25)
- Improved sendspin detection for sandboxed Kodi environments
- Use shell 'which' command as fallback
- Better logging of each detection step
- Check if path exists before testing

v2.1.3 (2024-12-25)
- Fixed sendspin detection - now tests by running sendspin directly
- Added auto-install option - will try pip install if sendspin not found
- Check if sendspin exits immediately after starting
- Better detection of python module installation

v2.1.2 (2024-12-25)
- Added verbose logging for sendspin detection
- Added "Sendspin Path" setting to manually specify sendspin location
- Checks more paths including OSMC, python module
- Better debugging when sendspin not found

v2.1.1 (2024-12-25)
- Fixed clicking on tracks - now works same as "Play Now" context menu
- Tracks no longer marked as playable (prevents Kodi playlist behavior)

v2.1.0 (2024-12-25)
- Fixed search functionality
- Fixed track clicking (no longer skips through tracks)
- Improved sendspin detection (checks more paths, uses shutil.which)
- Sendspin auto-start is now a setting that can be disabled
- Reduced log spam for missing sendspin

v2.0.9 (2024-12-25)
- Fixed search results (API returns 'radio' not 'radios')
- Improved error logging for 500 server errors
- Better error messages for playback failures

v2.0.8 (2024-12-22)
- Auto-start sendspin player for local playback (requires sendspin-cli installed)
- Auto-select sendspin player when available
- New settings: Auto-start Sendspin, Sendspin Player Name
- Seamless local playback experience

v2.0.7 (2024-12-22)
- Updated README with Sendspin local playback instructions
- Improved player selection dialog with setup guidance

v2.0.6 (2024-12-22)
- Playback now uses Music Assistant players (required for Apple Music, Spotify, etc.)
- Auto player selection if not configured
- Added set_default_player and select_player actions
- Removed direct streaming mode (not supported by DRM services)

v2.0.5 (2024-12-22)
- Extract stream URL from provider_mappings for direct playback
- Added fallback methods for stream URL retrieval
- Better debug logging for troubleshooting

v2.0.4 (2024-12-22)
- Fixed streaming: now calls API to get actual stream URL
- Added better error handling for playback failures
- Added debug logging for troubleshooting

v2.0.3 (2024-12-22)
- Added missing close() method to client

v2.0.2 (2024-12-22)
- Fixed authentication flow for MA 2.7+
- Use /auth/login endpoint instead of /api command
- Removed server info check before authentication

v2.0.1 (2024-12-22)
- Fixed API command structure for MA 2.7+
- Corrected library_items endpoint paths
- Fixed authentication command format

v2.0.0 (2024-12-22)
- Complete rewrite for Music Assistant 2.7+ API
- New authentication system with long-lived tokens
- Support for podcasts and audiobooks
- Improved streaming and playback
- Better error handling and connection management
- Updated UI with favorites support

v1.0.0 (2024-12-15)
- Initial release
        </news>
    </extension>
</addon>
